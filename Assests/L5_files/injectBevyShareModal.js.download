//Function for inject share modal
function injectBevyShareModal(cartData) {
    if (
      cartData.item_count > 0 &&
      shareCartCurrentStateData.checked &&
      shareCartCurrentStateData.checked === true &&
      (!shareCartCurrentStateData.loggedInUserEnabledOnly ||
        shareCartCurrentStateData.loggedInUserEnabledOnly === false ||
        (shareCartCurrentStateData.loggedInUserEnabledOnly === true &&
          isCustomerLoggedInBevy &&
          tagMatched))
    ) {
      modalInjected = true;
      const bevyShareModal = createElementFromHTML(htmltoshowModal);
      var bevyShareModalPosition = document.getElementsByTagName("body")[0];
      if (
        !document.getElementById("sharecartmodal") &&
        shareCartCurrentStateData
      ) {
        bevyShareModalPosition.appendChild(bevyShareModal);
        //insert input field for customized message
        var customizedMsgNote = document.getElementById("id_span_notetext");
        customizedMsgNote.innerHTML = shareCartCurrentStateData.notetext;
        if (
          shareCartCurrentStateData.customCartMessageStatus &&
          shareCartCurrentStateData.customCartMessageStatus === true
        ) {
          customizedMsgNote.innerHTML = "";
          customizedMsgNote.appendChild(
            createElementFromHTML(
              makeClickableText(shareCartCurrentStateData.notetextCustomCart)
            )
          );
          //Customized Msg
          var custom_msg_level = document.getElementById("customized_msg");
          custom_msg_level.innerHTML = shareCartCurrentStateData.customMsgLevel;
        }
  
        cartPermalink = shorthash(
          Date.now().toString(36) + Math.random().toString(36).substr(2)
        );
        cartToken = shorthash(shareCartData.token);
        sharelink =
          window.location.origin +
          "/a/cart?cart-token=" +
          cartToken +
          "&link-token=" +
          cartPermalink;
        document.getElementById("show_cart_permalink").value = sharelink;
  
        var isMobileDevice = false; //initiate as false
        // device detection
        if (
          /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(
            navigator.userAgent
          ) ||
          /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(
            navigator.userAgent.substr(0, 4)
          )
        ) {
          isMobileDevice = true;
        }
  
        var isMac = false;
        if (/(Mac)/i.test(navigator.platform)) {
          isMac = true;
        }
  
        var isSafari =
          /constructor/i.test(window.HTMLElement) ||
          (function (p) {
            return p.toString() === "[object SafariRemoteNotification]";
          })(
            !window["safari"] ||
              (typeof safari !== "undefined" && window["safari"].pushNotification)
          );
  
        document
          .querySelector(".copybtn-click")
          .addEventListener("click", async function (event) {
            copyClipboard();
          });
  
        document
          .getElementById("show_cart_permalink")
          .addEventListener("copy", function (event) {
            copyClipboard();
          });
  
        // modal
        var shareCartModal = document.getElementById("sharecartmodal");
        var shareCartClose = document.getElementById("show_cart_close");
  
        // When the user clicks on <span> (x), close the modal
        shareCartClose.onclick = function () {
          shareCartModal.style.display = "none";
          cartPermalink = shorthash(
            Date.now().toString(36) + Math.random().toString(36).substr(2)
          );
          cartToken = shorthash(shareCartData.token);
          sharelink =
            window.location.origin +
            "/a/cart?cart-token=" +
            cartToken +
            "&link-token=" +
            cartPermalink;
          document.getElementById("show_cart_permalink").value = sharelink;
          toggleContentShareMsg = false;
          $("#customized_msg_div").hide();
          var customizedMsgNote = document.getElementById("id_span_notetext");
          customizedMsgNote.style.display = "block";
          $(".emojionearea-editor").html(
            "Hi there, here's a customized cart, just for you!"
          );
        };
  
        // When the user clicks on social media icon
        document
          .querySelectorAll(".sociallinks_inner")
          .forEach((i) =>
            i.addEventListener(
              "mouseover",
              i.setAttribute("style", "cursor:pointer;")
            )
          );
  
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
          if (event.target == shareCartModal) {
            shareCartModal.style.display = "none";
            cartPermalink = shorthash(
              Date.now().toString(36) + Math.random().toString(36).substr(2)
            );
            cartToken = shorthash(shareCartData.token);
            sharelink =
              window.location.origin +
              "/a/cart?cart-token=" +
              cartToken +
              "&link-token=" +
              cartPermalink;
            document.getElementById("show_cart_permalink").value = sharelink;
            toggleContentShareMsg = false;
            $("#customized_msg_div").hide();
            var customizedMsgNote = document.getElementById("id_span_notetext");
            customizedMsgNote.style.display = "block";
            $(".emojionearea-editor").html(
              "Hi there, here's a customized cart, just for you!"
            );
          }
        };
  
        //social media links
        var socialmediadiv = document.querySelector("#social_wrap");
        var shareemailclick = document.getElementById("share_email");
        var emailiconwrap = document.getElementById("email_icon_wrap");
        var emailiconwrap2 = document.getElementById("email_icon_wrap2");
  
        if (shareemailclick)
          shareemailclick.addEventListener("click", function (e) {
            e.preventDefault();
            socialmediadiv.classList.toggle("display-none");
            emailiconwrap.classList.toggle("display-none");
            emailiconwrap2.classList.toggle("display-none");
            const labelShareButton = document.getElementsByClassName(
              "share_cart_modal_sociallinks_label"
            )[0];
            if (labelShareButton) {
              const labelShareButtonsChildrens = labelShareButton.children;
              var maxSocialBtnWidth = 0;
              var totalSocialBtnWidth = 0;
              for (
                var indx = 0;
                indx < labelShareButtonsChildrens.length;
                indx++
              ) {
                labelShareButtonsChildrens[indx].style.width = "unset";
                if (
                  labelShareButtonsChildrens[indx].offsetWidth > maxSocialBtnWidth
                ) {
                  maxSocialBtnWidth =
                    labelShareButtonsChildrens[indx].offsetWidth;
                }
                totalSocialBtnWidth =
                  totalSocialBtnWidth +
                  labelShareButtonsChildrens[indx].offsetWidth;
              }
              if (
                maxSocialBtnWidth > 0 &&
                totalSocialBtnWidth > labelShareButton.offsetWidth - 40
              ) {
                for (
                  var indx = 0;
                  indx < labelShareButtonsChildrens.length;
                  indx++
                ) {
                  labelShareButton.style.justifyContent = "center";
                  labelShareButtonsChildrens[indx].style.width =
                    maxSocialBtnWidth + "px";
                }
              } else if (
                maxSocialBtnWidth > 0 &&
                totalSocialBtnWidth <= labelShareButton.offsetWidth - 40
              ) {
                labelShareButton.style.justifyContent = "space-around";
              }
            }
          });
  
        var facebook = document.getElementById("facebook_icon_wrap");
        var messenger = document.getElementById("messenger_icon_wrap");
        var twitter = document.getElementById("twitter_icon_wrap");
        var tumblr = document.getElementById("tumblr_icon_wrap");
        var pinterest = document.getElementById("pinterest_icon_wrap");
        var whatsapp = document.getElementById("whatsapp_icon_wrap");
        var reddit = document.getElementById("reddit_icon_wrap");
        var email = document.getElementById("email_icon_wrapper");
  
        //Facebook
        facebook.addEventListener("click", function () {
          call_setcart();
          let fb_shareUrl =
            "https://www.facebook.com/sharer/sharer.php?u=" +
            encodeURIComponent(sharelink) +
            "&hashtag=%23" +
            socialCustomizationContent.facebook.hashtag;
          if (!isMobileDevice && isMac && isSafari) {
            const bevyFacebookAnchor = document.getElementById(
              "bevy-pinterest-anchor-button"
            );
            bevyFacebookAnchor.href = fb_shareUrl;
            bevyFacebookAnchor.click();
          } else {
            openPopup(fb_shareUrl);
          }
          return false;
        });
  
        messenger.addEventListener("click", function () {
          call_setcart();
          sharelink = sharelink.replace("-token", "");
          sharelink = sharelink.replace("-token", "");
          let messenger_shareUrl =
            "https://www.facebook.com/dialog/send?app_id=1473312793080648&display=popup&link=" +
            encodeURIComponent(sharelink) +
            "&utm_medium=facebook_messenger&utm_source=socialnetwork&redirect_uri=" +
            encodeURIComponent(sharelink);
          if (!isMobileDevice && isMac && isSafari) {
            const bevyFacebookAnchor = document.getElementById(
              "bevy-pinterest-anchor-button"
            );
            bevyFacebookAnchor.href = messenger_shareUrl;
            bevyFacebookAnchor.click();
          } else if (isMobileDevice) {
            window.open(
              "fb-messenger://share?link=" +
                encodeURIComponent(sharelink) +
                "&app_id=" +
                encodeURIComponent("1473312793080648")
            );
          } else {
            openPopup(messenger_shareUrl);
          }
          return false;
        });
  
        //Twitter
        twitter.addEventListener("click", function () {
          call_setcart();
          let tw_shareUrl =
            "https://twitter.com/intent/tweet?url=" +
            "&text=" +
            encodeURIComponent(
              socialCustomizationContent.twitter.text.replace(
                /\*\|SHARE_LINK\|\*/g,
                sharelink
              )
            ) +
            "&hashtags=" +
            socialCustomizationContent.twitter.hashtags;
          if (!isMobileDevice && isMac && isSafari) {
            const bevyTwitterAnchor = document.getElementById(
              "bevy-pinterest-anchor-button"
            );
            bevyTwitterAnchor.href = tw_shareUrl;
            bevyTwitterAnchor.click();
          } else {
            openPopup(tw_shareUrl);
          }
          return false;
        });
  
        //Whatapp
        whatsapp.addEventListener("click", function () {
          call_setcart();
          let wts_shareUrl =
            "https://api.whatsapp.com/send?text=" +
            encodeURIComponent(
              socialCustomizationContent.whatsapp.text.replace(
                /\*\|SHARE_LINK\|\*/g,
                sharelink
              )
            );
          if (!isMobileDevice && isMac && isSafari) {
            const bevyWhatsAppAnchor = document.getElementById(
              "bevy-pinterest-anchor-button"
            );
            bevyWhatsAppAnchor.href = wts_shareUrl;
            bevyWhatsAppAnchor.click();
          } else {
            openPopup(wts_shareUrl);
          }
          return false;
        });
  
        //Tumblr
        tumblr.addEventListener("click", function () {
          call_setcart();
          let tumblr_shareUrl =
            "http://www.tumblr.com/widgets/share/tool?canonicalUrl=" +
            encodeURIComponent(sharelink) +
            "&posttype=text" +
            "&title=" +
            socialCustomizationContent.tumblr.title +
            "&content=" +
            encodeURIComponent(
              socialCustomizationContent.tumblr.content.replace(
                /\*\|SHARE_LINK\|\*/g,
                sharelink
              )
            );
          if (!isMobileDevice && isMac && isSafari) {
            const bevyTumblrAnchor = document.getElementById(
              "bevy-pinterest-anchor-button"
            );
            bevyTumblrAnchor.href = tumblr_shareUrl;
            bevyTumblrAnchor.click();
          } else {
            openPopup(tumblr_shareUrl);
          }
          return false;
        });
  
        //Pinterest
        pinterest.addEventListener("click", function () {
          call_setcart();
  
          if (isMobileDevice) {
            var pinterest_shareUrl =
              "http://pinterest.com/pin/create/button/?url=" +
              encodeURIComponent(sharelink) +
              "&media=" +
              socialCustomizationContent.pinterest.media +
              "&description=" +
              encodeURIComponent(
                socialCustomizationContent.pinterest.description.replace(
                  /\*\|SHARE_LINK\|\*/g,
                  sharelink
                )
              );
            if (socialCustomizationContent.pinterest.autogenerate) {
              var xhr = new XMLHttpRequest();
              xhr.addEventListener(
                "load",
                function () {
                  pinterestMediaLinkJSON = JSON.parse(xhr.response);
                  if (
                    pinterestMediaLinkJSON &&
                    pinterestMediaLinkJSON.pinterestMediaUrl
                  ) {
                    pinterest_shareUrl =
                      "http://pinterest.com/pin/create/button/?url=" +
                      encodeURIComponent(sharelink) +
                      "&media=" +
                      pinterestMediaLinkJSON.pinterestMediaUrl +
                      "&description=" +
                      encodeURIComponent(
                        socialCustomizationContent.pinterest.description.replace(
                          /\*\|SHARE_LINK\|\*/g,
                          sharelink
                        )
                      );
                  }
                },
                false
              );
              xhr.open("POST", shareCartUrl + "/get/pinterest-media", false);
              xhr.setRequestHeader(
                "Content-Type",
                "application/json;charset=UTF-8"
              );
              xhr.setRequestHeader("Accept", "application/json");
              xhr.send(
                JSON.stringify({
                  shop: Shopify.shop,
                  cartProductsImages: cartProductsImages,
                })
              );
              const bevyPinterestAnchor = document.getElementById(
                "bevy-pinterest-anchor-button"
              );
              bevyPinterestAnchor.href = pinterest_shareUrl;
              bevyPinterestAnchor.click();
            } else {
              const bevyPinterestAnchor = document.getElementById(
                "bevy-pinterest-anchor-button"
              );
              bevyPinterestAnchor.href = pinterest_shareUrl;
              bevyPinterestAnchor.click();
            }
          } else {
            var pinterest_shareUrl =
              "http://pinterest.com/pin/create/button/?url=" +
              "&media=" +
              socialCustomizationContent.pinterest.media +
              "&description=" +
              encodeURIComponent(
                socialCustomizationContent.pinterest.description.replace(
                  /\*\|SHARE_LINK\|\*/g,
                  sharelink
                )
              );
  
            var pinterestWindowReference = null;
            if (!(isMac && isSafari)) {
              pinterestWindowReference = openPopupBlank();
            }
            if (socialCustomizationContent.pinterest.autogenerate) {
              var xhr = new XMLHttpRequest();
              xhr.addEventListener(
                "load",
                function () {
                  pinterestMediaLinkJSON = JSON.parse(xhr.response);
                  if (
                    pinterestMediaLinkJSON &&
                    pinterestMediaLinkJSON.pinterestMediaUrl
                  ) {
                    pinterest_shareUrl =
                      "http://pinterest.com/pin/create/button/?url=" +
                      "&media=" +
                      pinterestMediaLinkJSON.pinterestMediaUrl +
                      "&description=" +
                      encodeURIComponent(
                        socialCustomizationContent.pinterest.description.replace(
                          /\*\|SHARE_LINK\|\*/g,
                          sharelink
                        )
                      );
                  }
                },
                false
              );
              xhr.open("POST", shareCartUrl + "/get/pinterest-media", false);
              xhr.setRequestHeader(
                "Content-Type",
                "application/json;charset=UTF-8"
              );
              xhr.setRequestHeader("Accept", "application/json");
              xhr.send(
                JSON.stringify({
                  shop: Shopify.shop,
                  cartProductsImages: cartProductsImages,
                })
              );
              if (pinterestWindowReference) {
                pinterestWindowReference.location = pinterest_shareUrl;
              } else {
                const bevyPinterestAnchor = document.getElementById(
                  "bevy-pinterest-anchor-button"
                );
                bevyPinterestAnchor.href = pinterest_shareUrl;
                bevyPinterestAnchor.click();
              }
            } else {
              if (pinterestWindowReference) {
                pinterestWindowReference.location = pinterest_shareUrl;
              } else {
                const bevyPinterestAnchor = document.getElementById(
                  "bevy-pinterest-anchor-button"
                );
                bevyPinterestAnchor.href = pinterest_shareUrl;
                bevyPinterestAnchor.click();
              }
            }
          }
          return false;
        });
  
        //Reddit
        reddit.addEventListener("click", function () {
          call_setcart();
          let reddit_shareUrl =
            "https://www.reddit.com/submit?" +
            "title=" +
            socialCustomizationContent.reddit.title +
            "&selftext=true&text=" +
            encodeURIComponent(
              socialCustomizationContent.reddit.text.replace(
                /\*\|SHARE_LINK\|\*/g,
                sharelink
              )
            );
          if (!isMobileDevice && isMac && isSafari) {
            const bevyRedditAnchor = document.getElementById(
              "bevy-pinterest-anchor-button"
            );
            bevyRedditAnchor.href = reddit_shareUrl;
            bevyRedditAnchor.click();
          } else {
            openPopup(reddit_shareUrl);
          }
          return false;
        });
  
        //Email
        email.addEventListener("click", function () {
          call_setcart();
          let email_shareUrl =
            "mailto:?subject=" +
            encodeURIComponent(
              socialCustomizationContent.email.subject.replace(
                /\*\|SHARE_LINK\|\*/g,
                sharelink
              )
            ) +
            "&body=" +
            encodeURIComponent(
              socialCustomizationContent.email.body.replace(
                /\*\|SHARE_LINK\|\*/g,
                sharelink
              )
            );
          let window_size = "width=565,height=569";
          let new_window = open(
            email_shareUrl,
            "",
            "menubar=no,resizeable=yes,scrollbars=yes," + window_size
          );
          setTimeout(function () {
            new_window.close();
          }, 3000);
          return false;
        });
  
        var el2 = document.getElementById("id_div_shareyourcart");
        if (el2) {
          el2.innerHTML = shareyourcart;
        }
  
        var el_copy_confirmation_text = document.getElementById(
          "id_copy_confirmation_text"
        );
        if (el_copy_confirmation_text) {
          el_copy_confirmation_text.innerHTML = copyConfirmationText;
        }
  
        var el_copy_button_text = document.getElementById("id_copy_button_text");
        if (el_copy_button_text) {
          el_copy_button_text.innerHTML = copyButtonText;
        }
  
        var facebook_text = document.getElementById("facebook_label");
        if (facebook_text) {
          if (shareCartCurrentStateData.socialIconLinks[0])
            facebook_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[0].label;
        }
        var messenger_text = document.getElementById("messenger_label");
        if (messenger_text) {
          if (shareCartCurrentStateData.socialIconLinks[1])
            messenger_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[1].label;
        }
  
        var twitter_text = document.getElementById("twitter_label");
        if (twitter_text) {
          if (shareCartCurrentStateData.socialIconLinks[2])
            twitter_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[2].label;
        }
        var tumblr_text = document.getElementById("tumblr_label");
        if (tumblr_text) {
          if (shareCartCurrentStateData.socialIconLinks[3])
            tumblr_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[3].label;
        }
        var pinterest_text = document.getElementById("pinterest_label");
        if (pinterest_text) {
          if (shareCartCurrentStateData.socialIconLinks[4])
            pinterest_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[4].label;
        }
        var whatsapp_text = document.getElementById("whatsapp_label");
        if (whatsapp_text) {
          if (shareCartCurrentStateData.socialIconLinks[5])
            whatsapp_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[5].label;
        }
        var reddit_text = document.getElementById("reddit_label");
        if (reddit_text) {
          if (shareCartCurrentStateData.socialIconLinks[6])
            reddit_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[6].label;
        }
        var email_text = document.getElementById("email_label");
        if (email_text) {
          if (shareCartCurrentStateData.socialIconLinks[7])
            email_text.innerHTML =
              shareCartCurrentStateData.socialIconLinks[7].label;
        }
        var separator_text = document.getElementsByClassName("share_cart_or");
        if (
          separator_text &&
          separator_text.length > 0 &&
          shareCartCurrentStateData.separatorText
        ) {
          separator_text[0].innerHTML = shareCartCurrentStateData.separatorText;
        }
      }
    }
}